<!DOCTYPE html>
<html>
    <head>
        <title>PowerShell Service Manager</title>
        <link type="text/css" rel="stylesheet" href="fonts.css" />
        <link type="text/css" rel="stylesheet" href="vuetify.css" />
    </head>
<body>
<v-app id="root">


<v-toolbar color="blue darken-3" app dark  fixed >
    <v-toolbar-title data-app>PowerShell Service Manager
        <v-menu offset-y>
            <v-btn slot="activator" color="primary" dark >Help</v-btn>
            <v-list>
                <v-list-tile>
                <v-list-tile-title>About</v-list-tile-title>
                </v-list-tile>
            </v-list>
        </v-menu>
    </v-toolbar-title>
</v-toolbar>

<v-content>
    <v-container fill-height grid-list-md text-xs>
        <v-layout row wrap>
            <v-flex xs6>
                    <ps-dir class="drop" hostname="server1" filter="wsea*"></ps-dir>
            </v-flex>
            <v-flex xs6>
                    <ps-dir hostname="server2" filter="s*"></ps-dir>
            </v-flex>
        </v-layout>
    </v-container>
</v-content>

</v-app>

<script src="vue.js"></script>
<script src="vuetify.js"></script>
</body>
<script>
//console.log(process.env)
const dp = console.log;
const PS1 = require("./pshell_");
//PS.setConsole(console);
//var pow = require("./pow").pow;
const shell = require("node-powershell");
let PS= new shell({
    executionPolicy: 'Bypass',
    noProfile: false,
    verbose: true
});
PS.addCommand("Get-Service | Select -First 3");
PS.invoke().then((output) => {
    console.log("Output", output)
});
let app = {};

Vue.component('ps-dir', {
    props: ['hostname', 'filter'],
    data: function () {
        this.message=''; //PS.exec("Get-Location").Path
        if (!this.data) this.data = {results: null, Hostname: this.hostname, Filter: this.filter, message: this.message}
        try {
            this.getResults();
        } catch(e) {
            console.log(e.message)
        }
        return this.data;
    },
    //created() {},
    methods: {
        clickStart: function(SvcName) {
            try {
                let res = PS.exec(`Start-Service ${SvcName}`, {jsonOutput:false});
                if (res) return alert(res); // Silence means it's done
                this.getResults();
            } catch(e) {
                alert(e)
            }
        },
        clickRestart: function(SvcName) {
            try {
                let res = PS.exec(`Restart-Service ${SvcName}`, {jsonOutput:false});
                if (res) return alert(res); // Silence means it's done
                this.getResults();
            } catch(e) {
                alert(e)
            }
        },
        clickStop: function(SvcName) {
            try {
                let res = PS.exec(`Stop-Service ${SvcName}`, {jsonOutput:false});
                if (res) return alert(res); // Silence means it's done
                this.getResults();
            } catch(e) {
                alert(e)
            }
        },
        getResults: function() {
            statii=[null,"Stopped", "StartPending", "StopPending", "Running", "ContinuePending", "PausePending", "Paused"];
            try {
                let remoteCommand = `Get-Service | Select Name, Status, DisplayName, StartType -First 3`
    /*PS.addCommand("$pdd = Get-Content credential1.cred | ConvertTo-SecureString");
    PS.addCommand("$cred = New-Object -TypeName System.Management.Automation.PSCredential -Argumentlist marc,$pdd")
    console.log(`Invoke-Command -ComputerName localhost -ScriptBlock { ${remoteCommand} } -credential $cred | ConvertTo-Json`)
    PS.addCommand(`Invoke-Command -ComputerName localhost -ScriptBlock { ${remoteCommand} } -credential $cred | ConvertTo-Json`)
    */
    // PS.addCommand(remoteCommand);
    // PS.invoke()
    //     .then((output) => {
    //         console.log("Output", output)
    //         let results = JSON.parse(output)
    //         console.log(results);
    //         results.forEach((s)=>s.Status = statii[s.Status]);
    //         console.log(results[0])
    //     }).catch((err) => {
    //         console.error("ERROR", err)
    //     });
        //         let remoteCommand = `Get-Service ${this.data.Filter||""} | Select Name, Status, DisplayName, StartType`
        //         if (false) {
        //         PS.addCommand("$pdd = Get-Content credential1.cred | ConvertTo-SecureString;");
        //         PS.addCommand("$cred = New-Object -TypeName System.Management.Automation.PSCredential -Argumentlist marc,$pdd;")
        //         dp(`Invoke-Command -ComputerName localhost -ScriptBlock { ${remoteCommand} } -credential $cred | ConvertTo-Json`)
        //         PS.addCommand(`Invoke-Command -ComputerName localhost -ScriptBlock { ${remoteCommand} } -credential $cred | ConvertTo-Json`)
        //         }
        //         PS.addCommand(remoteCommand);
        //         PS.invoke()
        //             .then((output) => {
        //                 console.log("Output", output)
        //                 this.data.results = JSON.parse(output)
        //                 dp(this.data.results);
        //                 this.data.results.forEach((s)=>s.Status = statii[s.Status]);
        //                 console.log(this.data.results[0])
        //             }).catch((err) => {
        //                 console.error("ERROR", err)
        //             });
                //let command = "$password = Get-Content credential1.cred | ConvertTo-SecureString;"
                //command += "$cred = New-Object -TypeName System.Management.Automation.PSCredential -Argumentlist marc,$pass;"
                //command += `Invoke-Command -ComputerName localhost -ScriptBlock { ${remoteCommand} } -credential $cred`
                let command = `Get-Service ${this.data.Filter||""} | Select Name, Status, DisplayName, StartType`
                this.data.results = PS1.exec(command, {forceArray: true});
                dp("Waiting for results...")
            } catch (e) {
                this.$root._data.snack.message = e;
                this.$root._data.snack.show = true
                console.error(e);
            }
        }
    },
    template: `

  <v-card>
  <!--<v-btn flat icon @click="getResults()"><v-icon>replay</v-icon></v-btn>-->
  {{message}}
  <v-list style="max-height:300px; overflow-y:scroll; overflow-x:hidden;">
      <v-subheader><h4>{{Hostname}}</h4></v-subheader>
          <v-list-tile v-for="res in results" :key="res.Name">
            <v-icon :color="res.Status=='Running'?'green':'red'">check_circle</v-icon>
            <v-list-tile-content>
                <v-list-tile-title :title="res.Name" v-html="res.DisplayName"></v-list-tile-title>
                <v-list-tile-sub-title v-html="res.Status"></v-list-tile-sub-title>
            </v-list-tile-content>
            <v-btn flat small icon @click="clickReStart(res.Name)" color="blue"  :disabled="res.Status!='Running'"><v-icon>replay</v-icon></v-btn>
            <v-btn flat small icon @click="clickStart(res.Name)"   color="green" :disabled="res.Status=='Running'"><v-icon>play_arrow</v-icon></v-btn>
            <v-btn flat small icon @click="clickStop(res.Name)"    color="red"   :disabled="res.Status!='Running'"><v-icon>stop</v-icon></v-btn>
          </v-list-tile>
  </v-list>
</v-card>
`
});
app.root = new Vue({
  el: '#root',
  data: {
  },
  mounted: function() {
  }
});

if (process.env.NODE_ENV !== "production") {
    var gui = require('nw.gui');
    var win = gui.Window.get();
    // Set windows size and position for debugging
    win.moveTo(0, 0);
    win.resizeTo(850, 764);
    // Auto reload
    const reloadWatcher=require('fs').watch('./', function(a,b,c) {
        console.log(b); //return;
        location.reload();
        w1.close();
        reloadWatcher.close();
    });
}

//console.log(c1.change)
//console.log(c1.$data.message)
</script>
</html>